<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
        <script type="text/javascript" th:src="@{/js/stomp.js}"></script>
        <script>
            var stompC = null;
            var jsuid = null;
            
            function connect() {
                jsuid = document.getElementById('uid').innerHTML;
                console.log(jsuid);

                var socket = new WebSocket('ws://localhost:8080/websocket');
                stompC = Stomp.over(socket);
                stompC.connect({}, function(frame){
                    document.getElementById('connection').innerHTML = frame;
                    console.log('connected: '+frame);

                    stompC.subscribe('/sys/user-list', function(users){
                        console.log(users.body);
                        let v = JSON.parse(users.body);
                        document.getElementById('online-users').innerHTML="";
                        v.forEach(user => {
                            var p = document.createElement('p');
                            p.innerHTML = user;
    
                            document.getElementById('online-users').appendChild(p);
                        })
                    });

                    stompC.send("/app/init-users", {}, JSON.stringify({'to':"", 'content':jsuid, 'from':""}));


                    stompC.subscribe('/chat/'+jsuid, function(message){
                        var m = JSON.parse(message.body);
                        console.log(m.content);
                        showMessage(m);
                    })
                })
            }

            function send(){
                var to = document.getElementById('receiver').value;
                var m = document.getElementById('mess').value;
                console.log(to + ':'+m);
                stompC.send('/app/process-message', {}, JSON.stringify({'to':to, 'content':m}));
            }

            function showMessage(message){
                var p = document.createElement('p');
                p.innerHTML = message.content;
                p.className = 'right';

                document.getElementById('messagesDiv').appendChild(p);
            }

            function showSysMessage(message){
                var p = document.createElement('p');
                p.innerHTML = message.from;

                document.getElementById('friend-req').appendChild(p);
            }

            function sendMessage(to, content, dest){
                stompC.send(dest, {}, JSON.stringify({'to':to, 'content':content, 'from':jsuid}));
                
            }

            function dctest(){
                stompC.send('/app/update-users', {}, JSON.stringify({'to':'', 'content':'dc', 'from':jsuid}))
                stompC.disconnect();
                document.getElementById('online-users').innerHTML="";
            }

            // function addToFriends(){
                // sendMessage(user.value, "", "/app/process-friend-req");
                // const data = {
                //     to : user.value,
                //     content : "friend request",
                //     from : jsuid
                // };
                // fetch('http://localhost:8080/test/messages', {
				// 	method: 'POST',
				// 	headers: {
				// 		'Content-Type': 'application/json',
				// 	},
				// 	body: JSON.stringify(data),
				// })
				// .catch((error)=>{
				// 	console.error('Error:', error);
				// })
            // }
        </script>
<body>
    <p id="connection"></p>
    <button onclick="connect()">Connect</button>
    <button onclick="dctest()">DC TEST</button>
    <p id="uid" th:text="${UID}"></p>
    <div id="online-users"></div>
    <!-- <div id="usersDiv">
        <input type="text" id="mess" placeholder="Write a message..."/>
        <input type="text" id="receiver" placeholder="receiver"/>
        <button id="send" onclick="sendMessage()">Send</button>
    </div> -->
    <!-- <div id="friendsDiv"> -->
        <!-- <input type="text" id="user" placeholder="Enter friend's uid"/> -->
        <!-- <button onclick="addToFriends()">Send</button> -->
    <!-- </div> -->
    <!-- <div id="messagesDiv"> -->
    <!-- </div> -->
    <!-- <div th:insert="~{conversation(uid = ${UID})}"></div> -->
    <!-- <div id="friend-req">
        <p>Friend requests: </p>
        <p th:text="${uid}"></p>
    </div> -->
</body>
</html>
